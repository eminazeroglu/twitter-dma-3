import { useContextGlobal } from "../../../context/GlobalContext";
import { useForm } from "../../../hooks/useForm";
import { getMedia } from "../../../utils/helperUtil";
import LoadingIcon from '../../../components/ui/loading'
import Image from '../../../components/ui/image'
import { apiPost, apiPostFormData } from "../../../api/clinet";
import { TWEET_ENDPOINT } from "../../../api/tweetEndpoint";
import { useEffect, useState } from "react";
import { FiX } from "react-icons/fi";

function TweetForm({ onSuccess }) {

    const { storage: { user } } = useContextGlobal();
    const [photo, setPhoto] = useState('')

    const { values, setField, loading, resetTweet, handleSubmit } = useForm({
        initialState: {
            content: '',
            media: []
        },
        onSubmit: async values => {

            console.log(values);

            const tweetForm = {
                ...values,
            }
            
            if (values?.media?.length) {
                const form = new FormData()
                form.append('file', values.media[0])
                form.append('type', 'image')
                form.append('tweet_id', 1)
                const media = await apiPostFormData('/media', form)
    
                if (media?.data?.url) {
                    tweetForm.media = [
                        {
                            type: 'image',
                            url: media?.data?.url
                        }
                    ]
                }
            }
            

            const res = await apiPost(TWEET_ENDPOINT.tweets, tweetForm);
            if (res.status === 201) {
                setPhoto('')
                resetTweet();
                onSuccess();
            }
        }
    });

    const handleChange = (e) => {
        const ready = new FileReader()
        ready.onload = function (e) {
            setPhoto(e.target.result)
        }
        ready.readAsDataURL(e.target.files[0])
        setField('media', [e.target.files[0]])
    }

    const handleImageRemove = () => {
        setPhoto('')
    }

    useEffect(() => {
        return () => {
            setPhoto('')
        }
    }, [])

    return (
        <div className="px-[13px] pb-[7px]">
            <div className="flex gap-[20px] items-start w-full mt-[10px]">
                <Image
                    className="size-[48px]"
                    imgClassName="rounded-full" 
                    src={getMedia(user.profile_image)}
                />
                <form className="w-full">
                    <textarea
                        value={values.content}
                        onChange={e => setField('content', e.target.value)}
                        className="bg-transparent pt-[9px] h-[65px] w-full outline-none m-0 resize-none dark:text-[#fff] placeholder:text-[#6E767D] font-[400] placeholder:text-[20px] text-[20px]"
                        placeholder="Whatâ€™s happening?"
                    />
                </form>
            </div>
            {photo && (
                <div className="relative size-10">
                    <Image
                        className="size-10"
                        src={photo}
                    />
                    <button onClick={() => handleImageRemove()} className="absolute -top-2 -right-2 size-4 bg-primary rounded-full text-white inline-flex items-center justify-center">
                        <FiX/>
                    </button>
                </div>
            )}
            <div className="flex items-center justify-between ps-[70px]">

                <ul className="flex items-center gap-[15px]">
                    <li className="flex">

                        <label className="cursor-pointer">
                            <input onChange={(e) => handleChange(e)} accept="image/*" type="file" className="hidden" />
                            <svg
                                width={18}
                                height={18}
                                viewBox="0 0 18 18"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    d="M15.4583 0.666672H2.54166C1.50832 0.666672 0.666656 1.50834 0.666656 2.54167V15.4583C0.666656 16.4917 1.50832 17.3333 2.54166 17.3333H15.4583C16.4917 17.3333 17.3333 16.4917 17.3333 15.4583V2.54167C17.3333 1.50834 16.4917 0.666672 15.4583 0.666672ZM2.54166 1.91667H15.4583C15.8025 1.91667 16.0833 2.19751 16.0833 2.54167V10.605L12.8683 7.39001C12.7517 7.27334 12.5933 7.20667 12.4267 7.20667H12.4242C12.2575 7.20667 12.0967 7.27334 11.9808 7.39334L8.38332 11.0467L6.87249 9.54167C6.75582 9.425 6.59749 9.35834 6.43082 9.35834C6.26999 9.33334 6.10166 9.425 5.98499 9.54751L1.91666 13.7017V2.54167C1.91666 2.19751 2.19749 1.91667 2.54166 1.91667ZM1.92166 15.4833L6.43666 10.8717L11.6717 16.0833H2.54166C2.20666 16.0833 1.93582 15.815 1.92166 15.4833ZM15.4583 16.0833H13.4417L9.26916 11.9275L12.4292 8.71917L16.0833 12.3725V15.4583C16.0833 15.8025 15.8025 16.0833 15.4583 16.0833Z"
                                    fill="#1D9BF0"
                                />
                                <path
                                    d="M6.38998 7.20918C7.09967 7.20918 7.67498 6.63386 7.67498 5.92418C7.67498 5.21449 7.09967 4.63918 6.38998 4.63918C5.68029 4.63918 5.10498 5.21449 5.10498 5.92418C5.10498 6.63386 5.68029 7.20918 6.38998 7.20918Z"
                                    fill="#1D9BF0"
                                />
                            </svg>
                        </label>
                    </li>
                    <li className="flex">
                        <button>
                            <svg
                                width={20}
                                height={20}
                                viewBox="0 0 20 20"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    d="M15.8333 8.74999V7.33333H12.1666V12.6667H13.5833V11H15.25V9.58333H13.5833V8.74999H15.8333ZM9.74998 7.33333H11.1666V12.6667H9.74998V7.33333ZM6.74998 8.66666C7.08331 8.66666 7.49998 8.83333 7.74998 9.08333L8.74998 8.24999C8.24998 7.66666 7.49998 7.33333 6.74998 7.33333C5.24998 7.33333 4.08331 8.49999 4.08331 10C4.08331 11.5 5.24998 12.6667 6.74998 12.6667C7.58331 12.6667 8.24998 12.3333 8.74998 11.75V9.66666H6.41665V10.6667H7.41665V11.1667C7.24998 11.25 6.99998 11.3333 6.74998 11.3333C5.99998 11.3333 5.41665 10.75 5.41665 10C5.41665 9.33333 5.99998 8.66666 6.74998 8.66666Z"
                                    fill="#1D9BF0"
                                />
                                <path
                                    d="M17.0833 1.68333H2.91666C1.88332 1.68333 1.04166 2.5225 1.04166 3.55583V16.4783C1.04166 17.51 1.88332 18.35 2.91666 18.35H17.0833C18.1167 18.35 18.9583 17.51 18.9583 16.4783V3.55583C18.9583 2.5225 18.1167 1.68333 17.0833 1.68333ZM17.7083 16.4783C17.7083 16.82 17.4283 17.1 17.0833 17.1H2.91666C2.57166 17.1 2.29166 16.82 2.29166 16.4783V3.55583C2.29166 3.2125 2.57166 2.93333 2.91666 2.93333H17.0833C17.4283 2.93333 17.7083 3.2125 17.7083 3.55583V16.4783Z"
                                    fill="#1D9BF0"
                                />
                            </svg>
                        </button>
                    </li>
                    <li className="flex">
                        <button>
                            <svg
                                width={20}
                                height={20}
                                viewBox="0 0 20 20"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    d="M16.8517 7.63334H15.74C15.7525 7.55834 15.7633 7.48167 15.7633 7.40251V5.47501C15.7633 4.65834 15.0992 3.99417 14.2817 3.99417H2.91666V2.79834C2.91666 2.45334 2.63666 2.17334 2.29166 2.17334C1.94666 2.17334 1.66666 2.45334 1.66666 2.79834V17.3583C1.66666 17.7042 1.94666 17.9833 2.29166 17.9833C2.63666 17.9833 2.91666 17.7042 2.91666 17.3583V16.1633H11.7133C12.53 16.1633 13.195 15.4992 13.195 14.6825V12.755C13.195 12.6758 13.1833 12.5992 13.1717 12.5233H16.8525C17.6692 12.5233 18.3342 11.8583 18.3342 11.0417V9.11667C18.3342 8.29751 17.67 7.63334 16.8525 7.63334H16.8517ZM14.2833 5.24417C14.41 5.24417 14.5142 5.34751 14.5142 5.47501V7.40001C14.5142 7.52834 14.41 7.63334 14.2825 7.63334H2.91666V5.24167H14.2833V5.24417ZM11.9442 12.7558V14.6825C11.9442 14.81 11.84 14.9133 11.7125 14.9133H2.91666V12.5233H11.7133C11.8408 12.5233 11.9442 12.6283 11.9442 12.7567V12.7558ZM17.0833 11.0417C17.0833 11.1692 16.9792 11.2725 16.8517 11.2725H2.91666V8.88334H16.8517C16.9792 8.88334 17.0833 8.98667 17.0833 9.11417V11.0417Z"
                                    fill="#1D9BF0"
                                />
                            </svg>
                        </button>
                    </li>
                    <li className="flex">
                        <button>
                            <svg
                                width={20}
                                height={20}
                                viewBox="0 0 20 20"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    d="M9.99999 18.9583C5.05999 18.9583 1.04166 14.94 1.04166 10C1.04166 5.06001 5.05999 1.04167 9.99999 1.04167C14.94 1.04167 18.9583 5.06001 18.9583 10C18.9583 14.94 14.94 18.9583 9.99999 18.9583ZM9.99999 2.29167C5.74999 2.29167 2.29166 5.75001 2.29166 10C2.29166 14.25 5.74999 17.7083 9.99999 17.7083C14.25 17.7083 17.7083 14.25 17.7083 10C17.7083 5.75001 14.25 2.29167 9.99999 2.29167Z"
                                    fill="#1D9BF0"
                                />
                                <path
                                    d="M9.99998 14.2625C8.42332 14.2625 6.97248 13.4708 6.11998 12.1425C5.93332 11.8525 6.01748 11.4675 6.30832 11.28C6.59832 11.0917 6.98498 11.1767 7.17165 11.4683C7.79415 12.4367 8.85165 13.0142 10.0008 13.0142C11.15 13.0142 12.2075 12.4367 12.8308 11.4692C13.0175 11.1775 13.4042 11.0942 13.6942 11.2817C13.9858 11.4683 14.0692 11.855 13.8825 12.145C13.0283 13.4733 11.5775 14.2658 10.0008 14.2658L9.99998 14.2625Z"
                                    fill="#1D9BF0"
                                />
                                <path
                                    d="M12.2817 9.11334C12.9619 9.11334 13.5133 8.56191 13.5133 7.88168C13.5133 7.20145 12.9619 6.65001 12.2817 6.65001C11.6014 6.65001 11.05 7.20145 11.05 7.88168C11.05 8.56191 11.6014 9.11334 12.2817 9.11334Z"
                                    fill="#1D9BF0"
                                />
                                <path
                                    d="M7.7183 9.11334C8.39853 9.11334 8.94997 8.56191 8.94997 7.88168C8.94997 7.20145 8.39853 6.65001 7.7183 6.65001C7.03807 6.65001 6.48663 7.20145 6.48663 7.88168C6.48663 8.56191 7.03807 9.11334 7.7183 9.11334Z"
                                    fill="#1D9BF0"
                                />
                            </svg>
                        </button>
                    </li>
                    <li className="flex">
                        <button>
                            <svg
                                width={20}
                                height={20}
                                viewBox="0 0 20 20"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <g clipPath="url(#clip0_6_972)">
                                    <path
                                        d="M-31.5833 15C-31.6667 14.9167 -31.6667 14.9167 -31.6667 14.8333C-31.5833 14.8333 -31.5833 14.9167 -31.5833 15ZM15 1.83334H13.9167V1.58334C13.9167 1.25001 13.6667 0.916672 13.25 0.916672C12.9167 0.916672 12.5833 1.16667 12.5833 1.58334V1.83334H6.41668V1.58334C6.41668 1.25001 6.16668 0.916672 5.75001 0.916672C5.41668 0.916672 5.08334 1.16667 5.08334 1.58334V1.83334H4.00001C2.83334 1.83334 1.91668 2.75001 1.91668 3.91667V14.8333C1.91668 16 2.83334 16.9167 4.00001 16.9167H6.41668C6.75001 16.9167 7.08334 16.6667 7.08334 16.25C7.08334 15.9167 6.83335 15.5833 6.41668 15.5833H4.00001C3.50001 15.5833 3.16668 15.1667 3.16668 14.75V6.58334C3.16668 6.33334 3.50001 6 4.00001 6H15C15.5 6 15.8333 6.33334 15.8333 6.58334V8.08334C15.8333 8.41667 16.0833 8.75 16.5 8.75C16.8333 8.75 17.1667 8.5 17.1667 8.08334V3.91667C17.0833 2.75001 16.1667 1.83334 15 1.83334ZM15.8333 4.91667C15.5833 4.83334 15.25 4.75001 15 4.75001H4.00001C3.66668 4.75001 3.41668 4.83334 3.16668 4.91667V3.91667C3.16668 3.41667 3.58334 3.08334 4.00001 3.08334H5.08334V3.50001C5.08334 3.83334 5.33335 4.16667 5.75001 4.16667C6.08335 4.16667 6.41668 3.91667 6.41668 3.50001V3.08334H12.6667V3.50001C12.6667 3.83334 12.9167 4.16667 13.3333 4.16667C13.6667 4.16667 14 3.91667 14 3.50001V3.08334H15C15.5 3.08334 15.8333 3.50001 15.8333 3.91667V4.91667Z"
                                        fill="#1D9BF0"
                                    />
                                    <path
                                        d="M12.9167 8.66667C10.0833 8.66667 7.75 11 7.75 13.8333C7.75 16.6667 10.0833 19 12.9167 19C15.75 19 18.0833 16.6667 18.0833 13.8333C18.0833 11 15.75 8.66667 12.9167 8.66667ZM12.9167 17.8333C10.75 17.8333 9 16.0833 9 13.9167C9 11.75 10.75 10 12.9167 10C15.0833 10 16.8333 11.75 16.8333 13.9167C16.8333 16 15.0833 17.8333 12.9167 17.8333Z"
                                        fill="#1D9BF0"
                                    />
                                    <path
                                        d="M15.75 15.5833C15.6667 15.75 15.4167 15.9167 15.25 15.9167C15.1667 15.9167 15 15.9167 14.9167 15.8333L12.3334 14.1667V11.6667C12.3334 11.3333 12.5834 11 13 11C13.3334 11 13.6667 11.25 13.6667 11.6667V13.5L15.6667 14.75C15.8334 14.9167 15.9167 15.25 15.75 15.5833Z"
                                        fill="#1D9BF0"
                                    />
                                </g>
                                <defs>
                                    <clipPath id="clip0_6_972">
                                        <rect width={20} height={20} fill="white" />
                                    </clipPath>
                                </defs>
                            </svg>
                        </button>
                    </li>
                </ul>
                <button onClick={() => handleSubmit()} disabled={!values?.content} className="bg-[#1D9BF0] flex items-center disabled:opacity-50 text-white font-bold text-[15px] px-[16px] py-[9px] rounded-full">
                    {loading && <LoadingIcon />}
                    <span>Tweet</span>
                </button>
            </div>
        </div>
    );
}

export default TweetForm;